<?php

/**
  * Implements hook_menu()
  */
function bird_taxonomies_menu() {
  $items = array();
  $items['bird_taxonomies/ajax/species/%'] = array(
    'page callback' => 'bird_taxonomies_get_species_ajax_callback',
    'page arguments' => array(3),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['bird_taxonomies/ajax/subspecies/%'] = array(
    'page callback' => 'bird_taxonomies_get_subspecies_ajax_callback',
    'page arguments' => array(3),
    'access arguments' => array('access content'),    
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
  * Implements hook_taxonomies_block_info()
  */
function bird_taxonomies_block_info() {
  $blocks['bird_orders'] = array(
    'info' => t('Bird Orders'), 
  );
  
  return $blocks;
}

/**
  * Implements hook_taxonomies_block_view()
  */
function bird_taxonomies_block_view($delta = '') {
  // This example is adapted from node.module.
  $block = array();
    
  switch ($delta) {
    case 'bird_orders':
      $block['subject'] = t('Bird Orders');
      $block['content'] = array(
        '#orders' => bird_taxonomies_bird_orders(), 
        '#theme' => 'bird_taxonomies_bird_orders',
      );
      break;
  }
  return $block;
}

/**
  * Implements hook_theme()
  */
function bird_taxonomies_theme($existing, $type, $theme, $path) {
  return array(
    'bird_taxonomies_bird_orders' => array(
      'variables' => array('orders' => NULL,
    )), 
    'bird_taxonomies_bird_species' => array(
      'variables' => array('species' => NULL,
    )), 
    'bird_taxonomies_bird_subspecies' => array(
      'variables' => array('subspecies' => NULL,
    )), 
  );
}

function bird_taxonomies_bird_orders() {
  
  $result = db_query("SELECT node.title AS node_title, node.nid AS nid
                      FROM 
                      node node, field_data_field_ord_ordenacion ord
                      WHERE (( (node.status = '1') AND (node.nid = ord.entity_id) AND (node.type IN  ('order')) ))
                      ORDER BY ord.field_ord_ordenacion_value ASC");
  
  $orders = array();
  
  $families = bird_taxonomies_get_families();
  
  foreach ($result as $record) {
    // Do something with each $record    
    if(count($families[$record->nid] > 0)) {
      $orders[] = array( 'data' => '<span class="a-wrapper clearfix">'.l($record->node_title,'node/'.$record->nid).'<span class="go"><span>-></span></span></span>' . theme('item_list', array('items' => $families[$record->nid], 'attributes' => array ('class' => 'families'))),
      'class' => array('class' => (arg(1) == $record->nid) ? 'active selected' : ''));
    }
  }
        
  return $orders;
}

function bird_taxonomies_get_families($order = NULL) {

  $result = db_query("SELECT node.title AS node_title, node.nid AS nid, node_field_data_field_fam_order.nid AS node_field_data_field_fam_order_nid, node.created AS node_created, 'node' AS field_data_field_fam_order_ibc_node_entity_type
FROM 
{node} node
LEFT JOIN {field_data_field_fam_order} field_data_field_fam_order ON node.nid = field_data_field_fam_order.entity_id AND (field_data_field_fam_order.entity_type = 'node' AND field_data_field_fam_order.deleted = '0')
LEFT JOIN {node} node_field_data_field_fam_order ON field_data_field_fam_order.field_fam_order_nid = node_field_data_field_fam_order.nid
LEFT JOIN {field_data_field_fam_ordenacio} field_data_field_fam_ordenacio ON node.nid = field_data_field_fam_ordenacio.entity_id
WHERE (( (node.status = '1') AND (node.type IN  ('family')) ))
ORDER BY field_data_field_fam_ordenacio.field_fam_ordenacio_value ASC");
  
  $families = array();
  
  foreach ($result as $record) {
    // Do something with each $record
    //dsm($record);
    $families[$record->node_field_data_field_fam_order_nid][$record->nid] = array( 'data' => '<span class="a-wrapper clearfix">'.l($record->node_title,'node/'.$record->nid) . '<span class="go"><span>-></span></span></span>', 'id' => 'id-' . $record->nid);
  }
      
  return $families;
}

function bird_taxonomies_get_species_ajax_callback($family = NULL) {  
      
  $query = "SELECT node.title AS node_title, node.nid AS nid
FROM 
{node} node
LEFT JOIN {field_data_field_sp_family_nr} field_data_field_sp_family_nr ON node.nid = field_data_field_sp_family_nr.entity_id AND (field_data_field_sp_family_nr.entity_type = 'node' AND field_data_field_sp_family_nr.deleted = '0')
LEFT JOIN {node} node_field_data_field_sp_family_nr ON field_data_field_sp_family_nr.field_sp_family_nr_nid = node_field_data_field_sp_family_nr.nid
WHERE (( (node.status = '1') AND (node.type IN  ('species')) AND (node_field_data_field_sp_family_nr.nid = :family ) ))";

  if($countries_filter = get_global_filter_countries()) {
    $query .= " AND node.nid IN ($countries_filter)";
  }

  $query .= " ORDER BY node_title DESC";
    
  $result = db_query($query,array(':family' => $family));
        
  foreach ($result as $record) {
    // Do something with each $record
    //dsm($record);
    /*$species[$record->node_field_data_field_fam_order_nid ][$record->nid] = array( 'data' => l($record->node_title,'node/'.$record->nid),
      'class' => array('families'));
      */
      $species[] = $record;
  }
      
  print theme('bird_taxonomies_bird_species',array('species' => $species));
  exit();
}

function bird_taxonomies_get_subspecies_ajax_callback($specie = NULL) {

  $result = db_query("SELECT node.title AS node_title, node.nid AS nid, node.created AS node_created
FROM 
{node} node
LEFT JOIN {field_data_field_ssp_species} field_data_field_ssp_species ON node.nid = field_data_field_ssp_species.entity_id AND (field_data_field_ssp_species.entity_type = 'node' AND field_data_field_ssp_species.deleted = '0')
LEFT JOIN {node} node_field_data_field_ssp_species ON field_data_field_ssp_species.field_ssp_species_nid = node_field_data_field_ssp_species.nid
WHERE (( (node.status = '1') AND (node.type IN  ('subspecies')) AND (node_field_data_field_ssp_species.nid = :specie) ))
ORDER BY node_title DESC",array(':specie' => $specie));
    
  foreach ($result as $record) {
    // Do something with each $record
    //dsm($record);
    /*$species[$record->node_field_data_field_fam_order_nid ][$record->nid] = array( 'data' => l($record->node_title,'node/'.$record->nid),
      'class' => array('families'));
      */
      $subspecies[] = $record;
  }
          
  print theme('bird_taxonomies_bird_subspecies',array('subspecies' => $subspecies));
  exit();
}

/** Abre o cierra el menu segun donde estemos **/
function bird_taxonomies_menu_state() {
  
}

function theme_bird_taxonomies_bird_orders($variables) {
  $orders = $variables['orders'];
    
  $output = theme('item_list', array('items' => $orders, 'attributes' => array ('class' => 'orders')));
    
  return $output;  
}

function theme_bird_taxonomies_bird_species($variables) {
  $species = $variables['species'];

  if(!empty($species)) {
    foreach($species as $specie) {
      $items[] = array( 'data' => '<span class="a-wrapper clearfix">'.l(_hba_cursive($specie->node_title),'node/'.$specie->nid,array('html' => true)).'<span class="go"><span>-></span></span></span>', 'id' => 'id-' . $specie->nid);
    }
  }
  else {
    $items[] = array( 'data' => '<span class="a-wrapper clearfix">'. t('No species with the filter') . '</span>');

  }
    
  $output = theme('item_list', array('items' => $items, 'attributes' => array ('class' => 'species')));
    
  return $output;  
}

function theme_bird_taxonomies_bird_subspecies($variables) {
  $subspecies = $variables['subspecies'];
    
  foreach($subspecies as $subspecie) {
    $items[] = '<span class="a-wrapper clearfix">'.l($subspecie->node_title,'node/'.$subspecie->nid).'<span class="go"><span>-></span></span></span>';
  }
    
  $output = theme('item_list', array('items' => $items, 'attributes' => array ('class' => 'subspecies')));
    
  return $output;  
}

function get_global_filter_countries() {
    $countries = array();
    $country_filter = '';
    
    if(!empty($_SESSION['global_filter']['view_taxo_paisos'])) {
      $country_filter = "SELECT bd.nid_hbw FROM bird_countries as bd WHERE ";
      
      $country_filter .= 'bd.tid = ' . implode(' OR bd.tid = ', $_SESSION['global_filter']['view_taxo_paisos']);

    }
    else {
      $country_filter = false;
    }
    
    //dsm($country_filter);
    
    return $country_filter;
}

function bird_taxonomies_views_query_alter(&$view, &$query) {
  // (Example assuming a view with an exposed filter on node title.)
  // If the input for the title filter is a positive integer, filter against
  // node ID instead of node title.
  if ($view->name == 'species_table_by_family') {
    // Miramos si se ha de filtrar por paises
    $country_filter = get_global_filter_countries();
    
    if(!empty($country_filter)) {     
      //$view->header[]
          
      $result = db_query($country_filter);
            
      $nids = array();
      foreach ($result as $record) {
          $nids[] = $record->nid_hbw;
      }
           
      $view->query->where[] = 
            array( 'type' => 'AND',
                   'conditions' => array( 0 => array( 'field'    => 'node.nid',
                                                      'operator' => 'in',
                                                      'value'    => $nids, 
                                                    ),
                                        ),
                   'args' => array(),
                 );
    }
  }
}